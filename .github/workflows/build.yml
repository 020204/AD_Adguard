name: Convert and Update Rules

on:
  # è§¦å‘æ¡ä»¶
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰
    - cron: '0 0 * * *'
  
  # å½“ä»¥ä¸‹æ–‡ä»¶æœ‰å˜åŒ–æ—¶è§¦å‘
  push:
    paths:
      - 'me.txt'
      - 'adguard.txt'
      - 'convert.sh'
      - '.github/workflows/build.yml'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥å†…å®¹æ— å˜åŒ–ï¼‰'
        required: false
        default: 'false'

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      # 2. è®¾ç½®ç¯å¢ƒ
      - name: Setup environment
        run: |
          echo "GITHUB_REPOSITORY: ${{ github.repository }}"
          echo "GITHUB_REF: ${{ github.ref }}"
          echo "GITHUB_SHA: ${{ github.sha }}"
          date
      
      # 3. æ˜¾ç¤ºä»“åº“ç»“æ„
      - name: Show repository structure
        run: |
          echo "ğŸ“ ä»“åº“ç»“æ„:"
          find . -type f -name "*.txt" -o -name "*.yaml" -o -name "*.yml" -o -name "*.sh" | sort
          echo ""
          echo "ğŸ“„ æ–‡ä»¶ä¿¡æ¯:"
          ls -la *.txt *.sh 2>/dev/null || true
      
      # 4. è¿è¡Œè½¬æ¢è„šæœ¬
      - name: Convert rules
        id: convert
        run: |
          echo "ğŸš€ å¼€å§‹è½¬æ¢è§„åˆ™..."
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "me.txt" ]; then
            echo "âŒ é”™è¯¯: me.txt ä¸å­˜åœ¨"
            echo "ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶:"
            ls -la
            exit 1
          fi
          
          if [ ! -f "adguard.txt" ]; then
            echo "âŒ é”™è¯¯: adguard.txt ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "convert.sh" ]; then
            echo "âŒ é”™è¯¯: convert.sh ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç»™è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x convert.sh
          
          # æ˜¾ç¤ºè„šæœ¬ä¿¡æ¯
          echo "ğŸ“‹ è„šæœ¬ä¿¡æ¯:"
          head -20 convert.sh | grep -E "^#"
          
          # è¿è¡Œè½¬æ¢è„šæœ¬
          echo "ğŸ”„ æ‰§è¡Œè½¬æ¢..."
          ./convert.sh
          
          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
          echo "ğŸ“Š è½¬æ¢ç»“æœ:"
          if [ -f "me_clash.txt" ]; then
            RULES_COUNT=$(grep -c "^  - " me_clash.txt)
            echo "âœ… me_clash.txt: ${RULES_COUNT} æ¡è§„åˆ™"
          else
            echo "âŒ me_clash.txt æœªç”Ÿæˆ"
          fi
          
          if [ -f "clash.yaml" ]; then
            RULES_COUNT=$(grep -c "^  - " clash.yaml)
            echo "âœ… clash.yaml: ${RULES_COUNT} æ¡è§„åˆ™"
          else
            echo "âŒ clash.yaml æœªç”Ÿæˆ"
          fi
          
          # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
          echo "me_clash_rules=$RULES_COUNT" >> $GITHUB_OUTPUT
      
      # 5. æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      - name: Check for changes
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
          git status --porcelain
          
          CHANGED_FILES=$(git status --porcelain | wc -l)
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          if [ $CHANGED_FILES -gt 0 ]; then
            echo "ğŸ“ˆ å‘ç° $CHANGED_FILES ä¸ªæ–‡ä»¶æœ‰å˜åŒ–"
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå…·ä½“å˜åŒ–
            echo "ğŸ“„ å˜åŒ–çš„æ–‡ä»¶:"
            git status --porcelain
            
            # æ˜¾ç¤ºæ–‡ä»¶å·®å¼‚ï¼ˆå‰10è¡Œï¼‰
            for file in $(git diff --name-only); do
              echo ""
              echo "ğŸ”¸ æ–‡ä»¶: $file"
              echo "ğŸ“Š å·®å¼‚ç»Ÿè®¡:"
              git diff --stat "$file" | head -5
            done
          else
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜åŒ–"
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          fi
      
      # 6. æäº¤æ›´æ”¹
      - name: Commit and push changes
        if: steps.check_changes.outputs.HAS_CHANGES == 'true' || github.event.inputs.force_update == 'true'
        run: |
          echo "ğŸ“ æäº¤æ›´æ”¹..."
          
          # é…ç½® Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add me_clash.txt clash.yaml
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          if [ -f "me_clash.txt" ] && [ -f "clash.yaml" ]; then
            ME_RULES=$(grep -c "^  - " me_clash.txt)
            CLASH_RULES=$(grep -c "^  - " clash.yaml)
            COMMIT_MSG="ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™é›† ($COMMIT_DATE)
            
            ğŸ“Š è§„åˆ™ç»Ÿè®¡:
            - me_clash.txt: $ME_RULES æ¡è§„åˆ™
            - clash.yaml: $CLASH_RULES æ¡è§„åˆ™"
          else
            COMMIT_MSG="ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™é›† ($COMMIT_DATE)"
          fi
          
          # æäº¤
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ä»“åº“
          echo "ğŸš€ æ¨é€åˆ° GitHub..."
          git push
          
          echo "âœ… æ›´æ”¹å·²æäº¤"
      
      # 7. æ— å˜åŒ–æ—¶çš„å¤„ç†
      - name: No changes detected
        if: steps.check_changes.outputs.HAS_CHANGES == 'false' && github.event.inputs.force_update == 'false'
        run: |
          echo "ğŸ¯ è§„åˆ™æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
          echo "ğŸ“… ä¸‹æ¬¡è¿è¡Œæ—¶é—´: æ˜å¤© UTC 0 ç‚¹"
          echo "â° å½“å‰æ—¶é—´: $(date)"
      
      # 8. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
      - name: Generate report
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š GitHub Actions è¿è¡ŒæŠ¥å‘Š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸƒ è¿è¡Œå™¨: ${{ runner.os }}"
          echo "ğŸ“ ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          
          if [ -f "me_clash.txt" ]; then
            ME_RULES=$(grep -c "^  - " me_clash.txt)
            ME_SIZE=$(wc -c < me_clash.txt | awk '{print $1}')
            echo "ğŸ“„ me_clash.txt: $ME_RULES æ¡è§„åˆ™, ${ME_SIZE}å­—èŠ‚"
          fi
          
          if [ -f "clash.yaml" ]; then
            CLASH_RULES=$(grep -c "^  - " clash.yaml)
            CLASH_SIZE=$(wc -c < clash.yaml | awk '{print $1}')
            echo "ğŸ“„ clash.yaml: $CLASH_RULES æ¡è§„åˆ™, ${CLASH_SIZE}å­—èŠ‚"
          fi
          
          echo ""
          echo "ğŸ”— ç”Ÿæˆçš„æ–‡ä»¶é“¾æ¥:"
          echo "  - https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/me_clash.txt"
          echo "  - https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/clash.yaml"
          
          echo ""
          echo "ğŸ“‹ Clash ä½¿ç”¨ç¤ºä¾‹:"
          cat << 'EOF'
          
          # åœ¨ Clash é…ç½®ä¸­æ·»åŠ :
          rule-providers:
            me-rules:
              type: http
              behavior: domain
              url: "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/me_clash.txt"
              path: ./ruleset/me_clash.yaml
              interval: 86400
            
            adguard-rules:
              type: http
              behavior: domain
              url: "https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/clash.yaml"
              path: ./ruleset/adguard.yaml
              interval: 86400
          
          rules:
            - RULE-SET,me-rules,REJECT
            - RULE-SET,adguard-rules,REJECT
          EOF
